pipeline {
    agent {
        node {
            label 'awsvm'
        }
    }
    
     options    {
                timestamps()
                buildDiscarder(logRotator(numToKeepStr: '2', artifactNumToKeepStr: '2'))
                timeout(time: 1, unit: 'HOURS')
                disableConcurrentBuilds()
                }

    parameters {
            string(name: 'appBranch', defaultValue: 'master', description: "Application Branch name of the Repo")
            string(name: 'gitURL', defaultValue: 'https://github.com/pythonlifedevops/aws-b2-maven-app.git', description: "Pass the Maven Repo Source Code GIT URL")
                }  

    stages {
        stage('Git cloning') {
            steps 
            {
                
                git branch: 'main', url: 'https://github.com/sai-kadinti/aws-maven-project.git'
            }
        }
        stage('mvn build') {
            steps {
                sh ' mvn clean package'
            }
        }
        stage('docker build') {
            steps {
                sh ' docker build . -f dockerfile_testapp -t kadintisai/awsmaven:latest'
            }
        }
        stage('docker login') {
            steps {
                
                withCredentials([usernamePassword(credentialsId: 'dockerlogin', passwordVariable: 'dockerpwd', usernameVariable: 'dockeruser')]) {
                
                sh 'docker login -u ${dockeruser} -p ${dockerpwd}'
                }
            }
        }
        stage('docker push') {
            steps {
                sh 'docker push kadintisai/awsmaven:latest'
            }
        }
        stage('K8smanifest Checkout') {
            steps {
                git 'https://github.com/sai-kadinti/aws-k8s-cicd.git'
            }
        }
        stage('K8s Auto deployement') {
            steps {
                dir('manifests')
                {
                    sh 'ls -l'
                    sh 'kubectl --server=https://40D88BC734A6DB258A39280C0D07F75F.gr7.us-east-1.eks.amazonaws.com --insecure-skip-tls-verify --token="eyJhbGciOiJSUzI1NiIsImtpZCI6IjhkaWNkcFl3MFlKODhEMmF6VGRmMUJrYkdlVUI1TGNwZXZRajJ2V1Bfb3cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImplbmtpbnMtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiamVua2lucyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjRjMTUyZTVhLTEyNmMtNGYxNS05OTgwLTYxYWU3ZWZiNDcyOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmplbmtpbnMifQ.J58_PW-9pqDwZXAp1wdG3zxmcUP582nw7YzTbJxnreVGHMxmnPBJSu0Xh4SVZsaggos8oYCzHaLmGuO15ORxdtW9DNntbge-EJHhAM15OjXkXYhPT0lV0dv1Fp7LdN-EZrM16eyiFdzDnuUK-XSjNw31EVrtlNrf61bUSasYApZ6-7xcIh1NEg-_MPzGlF4A3soiILGSFzesbdEePZ4MWxL5L-U0LpbX1DNEFTGQ8wk3IOeG3SRv50mf7Fmeav-etTaCOyP29BwslTWPcUoIh_mbS6Bno0q_7GUSfRbGKhJAWauv1MvJVkMQudbRNoznehlsRJK_zZlS5QymDqjxMA" apply -f deployment.yml'
                    sh 'kubectl --server=https://40D88BC734A6DB258A39280C0D07F75F.gr7.us-east-1.eks.amazonaws.com --insecure-skip-tls-verify --token="eyJhbGciOiJSUzI1NiIsImtpZCI6IjhkaWNkcFl3MFlKODhEMmF6VGRmMUJrYkdlVUI1TGNwZXZRajJ2V1Bfb3cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImplbmtpbnMtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiamVua2lucyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjRjMTUyZTVhLTEyNmMtNGYxNS05OTgwLTYxYWU3ZWZiNDcyOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmplbmtpbnMifQ.J58_PW-9pqDwZXAp1wdG3zxmcUP582nw7YzTbJxnreVGHMxmnPBJSu0Xh4SVZsaggos8oYCzHaLmGuO15ORxdtW9DNntbge-EJHhAM15OjXkXYhPT0lV0dv1Fp7LdN-EZrM16eyiFdzDnuUK-XSjNw31EVrtlNrf61bUSasYApZ6-7xcIh1NEg-_MPzGlF4A3soiILGSFzesbdEePZ4MWxL5L-U0LpbX1DNEFTGQ8wk3IOeG3SRv50mf7Fmeav-etTaCOyP29BwslTWPcUoIh_mbS6Bno0q_7GUSfRbGKhJAWauv1MvJVkMQudbRNoznehlsRJK_zZlS5QymDqjxMA" apply -f service.yml'
                    sh 'kubectl --server=https://40D88BC734A6DB258A39280C0D07F75F.gr7.us-east-1.eks.amazonaws.com --insecure-skip-tls-verify --token="eyJhbGciOiJSUzI1NiIsImtpZCI6IjhkaWNkcFl3MFlKODhEMmF6VGRmMUJrYkdlVUI1TGNwZXZRajJ2V1Bfb3cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImplbmtpbnMtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiamVua2lucyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjRjMTUyZTVhLTEyNmMtNGYxNS05OTgwLTYxYWU3ZWZiNDcyOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmplbmtpbnMifQ.J58_PW-9pqDwZXAp1wdG3zxmcUP582nw7YzTbJxnreVGHMxmnPBJSu0Xh4SVZsaggos8oYCzHaLmGuO15ORxdtW9DNntbge-EJHhAM15OjXkXYhPT0lV0dv1Fp7LdN-EZrM16eyiFdzDnuUK-XSjNw31EVrtlNrf61bUSasYApZ6-7xcIh1NEg-_MPzGlF4A3soiILGSFzesbdEePZ4MWxL5L-U0LpbX1DNEFTGQ8wk3IOeG3SRv50mf7Fmeav-etTaCOyP29BwslTWPcUoIh_mbS6Bno0q_7GUSfRbGKhJAWauv1MvJVkMQudbRNoznehlsRJK_zZlS5QymDqjxMA" rollout restart deployment/java-app-deployment'

                    echo "K8s Deployement done...!!"

                    sh 'kubectl get deployments'
                    sh 'sleep 100 ; kubectl get services'
                }
                
            }
        }
        stage ('Archive and clean Workspace') {
            steps {
                archiveArtifacts artifacts: 'target/*.jar' , followSymlinks: false
                cleanWs() 
            }
        }
    }
    post {
        success {
            echo 'The pipeline succeed...!!'
        }
        failure {
            echo 'The pipeline failed....!!'
        }
    }
}
